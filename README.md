# ペンシルパズル盤面リーダー for スリザーリンク

* 「パズル通信ニコリ」のペンシルパズル「スリザーリンク」の盤面を画像認識で読み取り、データ化します。
  * カメラ画像をリアルタイムで読み取ることも、画像ファイルを読み込むこともできます。
* [スリザーリンクソルバー](https://github.com/tomoto/logic_puzzle_solver)と連携することにより、読み取った盤面をそのまま自動的に解き、結果を画像の上に重ね書きすることができます。
  ![](doc/slilin-reader.gif)
  こちら[オリジナルの動画](https://youtu.be/dcuR6_Ylt-8?si=AHdNFwGssayT5I7G)も参照。

## ビルド方法

* Python 3 が必要です。動作確認には Python 3.11.4 を使用しています。専用環境でない限り、venv で仮想環境を作ることをお勧めします。
* `pip install -r requirements.txt` で必要なライブラリをインストールします。
* `bin` ディレクトリにソルバーの実行ファイルを配置します。
  * Windows と Linux(x86) 用のビルド済みバイナリを入れてありますが、実行できない場合は[こちら](https://github.com/tomoto/logic_puzzle_solver)から自分でビルドしてください。

## 使用方法

* `detect_slilin.py` を開いて `input` や `output_mode` をお好みに設定し、`python detect_slilin.py` で実行してください。
* デフォルトではカメラ画像をリアルタイムで読み取り(`input = "camera"`)、解いた結果を画像の上にオーバーレイ表示(`output_mode = "solver_to_image"`)します。
  * `bin` ディレクトリにソルバーを配置しておく必要があります。
  * 盤面データと結果画像が `out` ディレクトリ下に保存されます。
* ソルバーが使えない場合でも、`output_mode` を `"stdout"` や `"file"` に設定すれば読み取りまで動作します。
  * 盤面データは標準出力に出力、または `out` ディレクトリ下に保存されます。
* 画像ウィンドウ上で何かキーを押すと終了します。

## その他

* 盤面を正しく認識するには幾つかコツがあります:
  * マスのサイズが50～60ピクセル程度だと認識しやすいです。大きすぎても小さすぎてもうまくいきません。
  * 盤面の左上隅が入力画像の左上になるべく近くなるようにしてください。他の点を盤面左上だと誤認識させないためです。
  * 盤面の左上隅・上辺・左辺を足掛かりにに全体の構造を推測するので、これらが正しく認識されることが重要です。
  * 90度単位の回転は問題なく扱え、正立した盤面データが得られます。左上にノイズが比較的少ない、認識させやすい角度で撮影してください。
* 入力がカメラの場合、起動に時間がかかる(10秒以上)場合があります。焦らず待ってください。
  * なお、WSL ではいろいろ手間をかけないと USB カメラが使えないそうです(2025年1月時点)。画像ファイル入力を使うか、Windows で直接実行することをお勧めします。
* 画像処理には OpenCV を、数字の認識には TensorFlow を使用しています。
* 数字認識モデルは `data` 以下の画像で訓練しています。再訓練は `python .\lib\digit_model_trainer.py` で可能です。